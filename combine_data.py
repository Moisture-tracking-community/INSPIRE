#### Necessary libraries ####
import os
from pathlib import Path

import xarray as xr

from Functions import grid_cell_area


def read_wam2layers(basedir):
    """Read data for WAM2layers."""
    path = Path(basedir) / "results WAM2layers"
    # Data loading this way gives an error message for me while plotting, but in principe it should work
    dsall = xr.open_mfdataset(
        path.glob("backtrack_*T00-00.nc"),
        combine="nested",
        concat_dim="time",
    ).rename(latitude="lat", longitude="lon")

    # Convert units
    # TODO might not be necessary with latest version of data, see
    # https://github.com/WAM2layers/Moisture_tracking_intercomparison/issues/43
    lat = dsall.lat.values
    lon = dsall.lon.values

    a_gridcell_new = grid_cell_area(lat, lon)
    E_track_totalmm = (dsall / a_gridcell_new) * 1000  # mm
    srcs_wam2layers_new = E_track_totalmm["e_track"].sum("time")  # mm

    return {"wam2layers_new": srcs_wam2layers_new}


def read_wrf_wvt(basedir):
    raise NotImplementedError("Not availabe as netCDF due to nature of simulations.")


def read_uvigo(basedir):
    """Read data from University of Vigo"""
    path = Path(basedir) / "results Uvigo"
    return {
        "Vigo_e2_Sodemann": xr.open_dataarray(path / "ERA5_SJ05_reg.nc"),
        "Vigo_e1_Stohl": xr.open_dataarray(path / "ERA5_APA22_reg.nc"),
    }


def read_utrack(basedir):
    """Read data from UTRACK.

    Data is generated by Arie Staal.

    Based on the communication with Arie the
    results should be area corrected. Given the values I assumed that the area
    needs to be in km**2, however this should be checked.
    """
    # TODO check units with Arie
    n_gridcells_pakistan = (71 - 67) / 0.25 * (30 - 24) / 0.25

    path = Path(basedir) / "results Utrack Arie Staal/moisture_tracking_intercomparsion"

    ensemble_members = {
        "utrack_e1": path.glob("*_mixing48h_dt025h_100p.nc"),
        "utrack_e2": path.glob("*_mixing24h_dt025h_100p.nc"),
        "utrack_e3": path.glob("*_mixing12h_dt025h_100p.nc"),
        "utrack_e4": path.glob("*_mixing24h_dt025h_1000p.nc"),
        "utrack_e5": path.glob("*_mixing24h_dt010h_100p.nc"),
    }

    ensemble = {}
    for member, files in ensemble_members.items():
        ensemble[member] = (
            xr.open_mfdataset(
                files,
                combine="nested",
                concat_dim="time",
            )["moisture_source"].sum("time")
            * n_gridcells_pakistan
        )

    return ensemble


def read_ughent(basedir):
    """Read data from university of Ghent.

    Generated with HAMSTER.
    """
    base = Path(basedir) / "results UGhent HAMSTER/Pakistan simulations/bias_corrected"

    ensemble_members = {
        "ghent_e1": "ens1_sod08",
        "ghent_e2": "ens2_fas19",
        "ghent_e3": "ens3_rh20",
        "ghent_e4": "ens4_allabl",
        "ghent_e5": "ens5_rhadap80",
    }

    ensemble = {}
    for name, ens in ensemble_members.items():
        files = (base / ens).glob(f"bias_corrected_202208*120000_{ens[5:]}.nc")
        ensemble[name] = xr.open_mfdataset(
            files, combine="nested", concat_dim="time"
        ).sum("time")["E2P_BC"]

    return ensemble


def read_tracmass(basedir):
    """Read tracmass data.

    Data supplied by Dipanjan Dey
    Units in mm/day, so multiplied with # of event days.
    """
    nrdays = 15

    diagnostics_path = (
        Path(basedir) / "results TRACMASS Dipanjan Dey/TRACMASS_diagnostics.nc"
    )
    ds = xr.open_dataset(diagnostics_path)  # Evaporative sources (and preicp?) mm/day

    # Not used, but good to know it's available.
    # pr_path = Path(basedir) / "results TRACMASS Dipanjan Dey/PR_ERA5_TRACMASS.nc"
    # ds_pr_TRACMASS = xr.open_dataset(pr_path)  # Precip ERA5 and TRACMASS Comparison

    # convert to -180 to 180 lon
    ds.coords["lon"] = (ds.coords["lon"] + 180) % 360 - 180
    ds = ds.sortby(ds.lon)

    # Units of data is mm/day but we want mm over whole time period
    srcs_TRACMASS = ds["E_TRACMASS"] * nrdays

    return {
        "TRACMASS": srcs_TRACMASS,
    }


def read_flexpart_tatfancheng(basedir):
    ########################################################
    ## FLEXPART-Watersip TatFanCheng                      ##
    ########################################################
    filename = (
        basedir
        + "results FLEXPART_WaterSip_TatFanCheng/WaterSip_Cb_20220810-20220824_Pakistan_box.nc"
    )
    ds_flexpart_tatfancheng = xr.open_dataset(filename)

    # convert to -180 to 180 lon
    ds_flexpart_tatfancheng.coords["lon"] = (
        ds_flexpart_tatfancheng.coords["lon"] + 180
    ) % 360 - 180

    # Use TRACMASS to sort
    ds_TRACMASS = read_tracmass(basedir)["TRACMASS"]
    ds_flexpart_tatfancheng = ds_flexpart_tatfancheng.sortby(ds_TRACMASS.lon)
    srcs_flexpart_tatfancheng = ds_flexpart_tatfancheng.sum("time")["Cb"]

    return {
        "flexpart_tatfancheng": srcs_flexpart_tatfancheng,
    }


def read_flexpart_xu(basedir):
    ########################################################
    ## Flexpart Ru Xu                                     ##
    ########################################################
    ds_flexpart_xu = xr.open_dataset(
        basedir + "results Ru_Xu_FLEXPART/e_daily.nc"
    ).rename(latitude="lat", longitude="lon")
    srcs_flexpart_xu = ds_flexpart_xu["variable"].sum("time")
    return {
        "flexpart_xu": srcs_flexpart_xu,
    }


def read_lagranto_chc(basedir):
    ########################################################
    ## Lagranto CHc                                       ##
    ########################################################
    ds_lagranto_CHc = xr.open_dataset(
        basedir + "results CHc LAGRANTO/Pakistan_2022_CHc_eventtotal_ens1.nc"
    ).rename(dimx_N="lon", dimy_N="lat")
    srcs_lagranto_CHc = ds_lagranto_CHc["N"].sum("time").squeeze()

    # Use TRACMASS to get coordinate values
    srcs_TRACMASS = read_tracmass(basedir)["TRACMASS"]
    srcs_lagranto_CHc = srcs_lagranto_CHc.assign_coords(
        lat=srcs_TRACMASS.lat[::-1], lon=srcs_TRACMASS.lon
    )
    return {
        "lagranto_CHc": srcs_lagranto_CHc,
    }


def read_flexpart_univie():
    ########################################################
    ## FLEXPART UniVie                                    ##
    ########################################################
    ds_flexpart_univie = xr.open_dataset(
        basedir + "results univie FLEXPART/pakistan_univie.nc"
    )
    srcs_flexpart_univie = (
        ds_flexpart_univie["moisture_uptakes_bl"]
        + ds_flexpart_univie["moisture_uptakes_ft"]
    ).sum("time")

    return {
        "flexpart_univie": srcs_flexpart_univie,
    }


def read_2ldrm(basedir):
    #######################################################
    # 2LDRM                                              ##
    #######################################################
    ds_2ldrm = xr.open_dataset(
        basedir + "results 2LDRM/2LDRM_Pakistan_case_gl.nc"
    ).rename(latitude="lat", longitude="lon")
    srcs_2ldrm = ds_2ldrm["moisture_source"].sum("time").T

    return {
        "2ldrm": srcs_2ldrm,
    }


def read_flexpart_uib(basedir):
    #######################################################
    # FLEXPART UiB                                       ##
    #######################################################
    ds_flexpart_uib = xr.open_dataset(
        basedir
        + "results UiB FLEXPART WaterSip/Pakistan_2022_UiB_Sodemann_grid_EN1_regridded.nc"
    )
    srcs_flexpart_uib = ds_flexpart_uib["moisture_uptakes"]
    return {
        "flexpart_uib": srcs_flexpart_uib,
    }


def read_data_pakistan(basedir):
    """Examples of data loading of moisture sources

    Data is loaded per individual ensemble member for each model.
    All data is converted to mm evaporative sources over the whole time period

    # TODO: I think this comment is outdated, right?
    WRF-WVT is not included yet, as well CHc Lagranto and univie FLEXPART

    There might also be a few (new) ensemble members not included yet:
    - For the HAMSTER model (Ughent) there is an additional ensemble member not included yet
    - Extra ensemble members of Flexpart-Watersip produced by Fandy
    """
    # Combine cumulative moisture sources for all models in one netcdf
    datasets = {
        # TODO: uncomment after editing (don't have the latest data atm)
        # **read_2ldrm(basedir),
        # **read_flexpart_uib(basedir),
        **read_lagranto_chc(basedir),
        **read_flexpart_xu(basedir),
        **read_flexpart_tatfancheng(basedir),
        **read_tracmass(basedir),
        **read_ughent(basedir),
        **read_utrack(basedir),
        **read_uvigo(basedir),
        **read_wam2layers(basedir),
    }

    all_maps = xr.Dataset(datasets)

    return all_maps
